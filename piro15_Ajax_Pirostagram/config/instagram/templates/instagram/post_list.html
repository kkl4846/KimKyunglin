{% extends 'instagram/base.html' %}

{% block content %}
<div class="d-flex flex-column " style="align-items:center;">
{% for post in all_post %}
<div class="row post-id-{{ post.id }} mt-3 mb-5 "
    style=" border: solid; border-radius: 30px; border-color: lightgray; width: 80%; height: 600px;">
    {% if post.image %}
    <div class="col d-flex align-items-center ">
        <img src="{{post.image.url}}" style="width: 100%; border-radius: 30px;"/>
    </div>
    {%endif%}

    <div class="col d-flex flex-column position-relative">
        <div class="text-center">{{post.title}}</div>
        <hr class="my-2">
        <div style="height: 200px;">{{post.content}}</div>
        ëŒ“ê¸€
        <hr class="my-1">
        <div class="post_{{post.id}} comments" >
            {%if all_comment%}
            {%for comment in all_comment %}
            {%if comment.post.id == post.id%}
            <div class="comment_object_{{comment.id}} d-flex justify-content-between">
                {{comment.comment_content}}<div class="btn btn-outline-secondary delete" onclick="onClickDelete({{comment.id}} )">ì‚­ì œ
                </div>
            </div>
            {%endif%}
            {%endfor%}
            {%endif%}
        </div>

      

        <div class="position-absolute bottom-0" style="width: 90%;">
            <hr class="my-2">
            {%if post.like == 1 %}
            <div >
                <span class="btn btn- post__like" onclick="onClickLike({{post.id}}, 'like')">â¤ï¸</span>
                <span class="heart_comment_{{post.id}}">ì´ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤!</span>
            </div>
            {%else%}
            <div>
                <span class="btn btn- post__dislike" onclick="onClickLike({{post.id}}, 'dislike')">ğŸ¤</span>
                <span class="heart_comment_{{post.id}}">ê²Œì‹œë¬¼ì´ ë§ˆìŒì— ë“œì‹œë©´ ì¢‹ì•„ìš”ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!</span>
            </div>
            {%endif%}
            <hr class="my-2">
            <form action="comment_create/" method="POST">
                {% csrf_token %}
                <input type="text" name="comment_content" id="comment_{{post.id}}" value='ëŒ“ê¸€ë‹¬ê¸°...' style="width: 80%;">
                <div class="btn btn-outline-dark submit"
                    onclick="onClickComment({{post.id}}, document.querySelector('#comment_{{post.id}}').value)">
                    submit
                </div>
            </form>
        </div>

    </div>
</div>
{%endfor%}
</div>
<script>

    //1.ì¢‹ì•„ìš” ê¸°ëŠ¥
    const requestLike = new XMLHttpRequest();
    const onClickLike = (id, type) => {
        const url = '/like_ajax/';
        requestLike.open('POST', url, true);
        requestLike.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'

        );
        requestLike.send(JSON.stringify({ id: id, type: type }));
    };

    const likeHandleResponse = () => {
        if (requestLike.status < 400) {
            const { id, type } = JSON.parse(requestLike.response)
            const element = document.querySelector(`.post-id-${id} .post__${type}`)
            if (element.innerHTML === 'â¤ï¸') {
                const heart_comment=document.querySelector(`.heart_comment_${id}`)
                heart_comment.innerHTML="ê²Œì‹œë¬¼ì´ ë§ˆìŒì— ë“œì‹œë©´ ì¢‹ì•„ìš”ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!"
                element.innerHTML = 'ğŸ¤';

            }


            else {
                const heart_comment=document.querySelector(`.heart_comment_${id}`)
                heart_comment.innerHTML="ì´ ê²Œì‹œë¬¼ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì…¨ìŠµë‹ˆë‹¤!"
                element.innerHTML = 'â¤ï¸'
            }
        }


    }

    requestLike.onreadystatechange = () => {
        if (requestLike.readyState === XMLHttpRequest.DONE) {
            likeHandleResponse();

        }
    }
    //2. ëŒ“ê¸€ ì…ë ¥
    const requestComment = new XMLHttpRequest();

    const onClickComment = (id_comment, comment_content) => {
        const url_comment = 'comment_create/';
        requestComment.open('POST', url_comment, true);
        requestComment.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'

        );
        requestComment.send(JSON.stringify({ id_comment: id_comment, comment_content: comment_content }));
    };


    const commentHandleResponse = () => {
        if (requestComment.status < 400) {
            const { post_id, comment_content, comment_id } = JSON.parse(requestComment.response)
            const element_comment = document.querySelector(`.post_${post_id}.comments`)  //í´ë˜ìŠ¤ ì´ë¦„ì´ 'post_{post.id} comments' ->ì¤‘ê°„ì— ë¹ˆì¹¸ì´ ë“¤ì–´ê°€ë©´ í´ë˜ìŠ¤ ë„¤ì„ì´ ë‘ê°œì¸ ê²ƒ. ë”°ë¼ì„œ ë‘˜ë‹¤ ì–¸ê¸‰í•´ì¤€ë‹¤. 
            const newDiv = document.createElement('div')
            newDiv.className = `comment_object_${comment_id} d-flex justify-content-between`;
            newDiv.innerHTML = `${comment_content}<div class="btn btn-outline-secondary delete" onclick="onClickDelete(${comment_id} )">ì‚­ì œ</div>`
            element_comment.appendChild(newDiv)
            //ëŒ“ê¸€ ì…ë ¥ì°½ ë¹„ì›Œì£¼ê¸°
            const input_content = document.querySelector(`#comment_${post_id}`)
            input_content.value = null

        }
    }
    requestComment.onreadystatechange = () => {
        if (requestComment.readyState === XMLHttpRequest.DONE) {
            commentHandleResponse();
        }
    }

    //3.ëŒ“ê¸€ ì‚­ì œ
    const requestDelete = new XMLHttpRequest();

    const onClickDelete = (comment_id) => {
        const url = '/comment_delete/';
        requestDelete.open('POST', url, true);
        requestDelete.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'

        );
        requestDelete.send(JSON.stringify({ comment_id: comment_id }));
    };


    const deleteHandleResponse = () => {
        if (requestDelete.status < 400) {
            const { comment_id } = JSON.parse(requestDelete.response)

            const delete_element = document.querySelector(`.comment_object_${comment_id}`)
            const element_comment = delete_element.closest('.comments')     //í´ë˜ìŠ¤ ì´ë¦„ì´ 'post_{post.id} comments'ë¡œ ë‘ê°œì´ë‹¤. post.idì— ëŒ€í•œ ì •ë³´ëŠ” ì—†ìœ¼ë¯€ë¡œ .commentsë¼ëŠ” í´ë˜ìŠ¤ë§Œ ì–¸ê¸‰í•˜ì—¬ ë¶€ëª¨ ìš”ì†Œë¥¼ selectí•œë‹¤.
            element_comment.removeChild(delete_element)

        }


    }

    requestDelete.onreadystatechange = () => {
        if (requestDelete.readyState === XMLHttpRequest.DONE) {
            deleteHandleResponse();

        }
    }

</script>

{% endblock %}